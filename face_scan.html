<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Face Card Checking</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
<script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

<style>
    body {
        margin: 0;
        padding: 0;
        background: black;
        font-family: "Space Grotesk", "Space Mono";
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        text-align: center;
        overflow-x: hidden;
    }

    #small-title {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 3px;
        color: #888;
        margin-top: 25px;
        font-family: "Space Mono";
    }

    #main-status {
        font-size: 1.7rem;
        letter-spacing: 4px;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 0 0 10px rgba(255,255,255,0.4); 
        transition: color 0.3s ease, text-shadow 0.3s ease;
    }

    /* CONTAINER FOR P5 CANVAS */
    #canvas-wrapper {
        position: relative;
        width: 90%;
        max-width: 600px;
        /* We let JS set the height to maintain aspect ratio */
        border: 4px solid white;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* P5 Canvas styling */
    canvas {
        display: block;
        width: 100% !important;
        height: 100% !important;
        /* Mirror the view */
        transform: scaleX(-1);
    }

    /* Progress Meter Overlays */
    #progress-meter {
        width: 110px;
        height: 110px;
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 20;
        pointer-events: none; /* Let clicks pass through */
    }

    #progress-svg {
        transform: rotate(-90deg);
    }

    .circle-bg {
        fill: none;
        stroke: rgba(255, 255, 255, 0.3);
        stroke-width: 5;
    }

    #progress-circle {
        fill: none;
        stroke: white;
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.1s linear;
    }

    #progress-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.3rem;
        font-weight: bold;
        color: white;
    }

    #next-btn {
        margin-top: 20px;
        padding: 12px 40px;
        background: white;
        color: black;
        border-radius: 50px;
        font-weight: 700;
        text-decoration: none;
        display: none;
        text-transform: uppercase;
        margin-bottom: 30px;
    }

    /* MOBILE TWEAKS */
    @media (max-width: 600px) {
        #progress-meter { width: 85px; height: 85px; }
        #main-status { font-size: 1.3rem; }
    }
</style>
</head>
<body>

<div id="small-title">✵ FACE CARD CHECKING ✵</div>
<div id="main-status">SYSTEM READY</div>

<div id="canvas-wrapper">
    <div id="progress-meter">
        <svg id="progress-svg" width="100%" height="100%" viewBox="0 0 150 150">
            <circle class="circle-bg" cx="75" cy="75" r="70"/>
            <circle id="progress-circle" cx="75" cy="75" r="70"/>
        </svg>
        <div id="progress-value">0%</div>
    </div>
</div>

<a href="eye_scanning.html" id="next-btn">Continue</a>

<script>
    let faceMesh;
    let video;
    let faces = [];
    const options = { maxFaces: 1, refineLandmarks: true, minConfidence: 0.5 };

    const totalKeypoints = 468;
    let revealedKeypoints = new Array(totalKeypoints).fill(false);
    let revealedCount = 0;
    let isScanning = false;

    // DOM Elements
    const mainStatusEl = document.getElementById('main-status');
    const progressValueEl = document.getElementById('progress-value');
    const progressCircleEl = document.getElementById('progress-circle');
    const nextBtnEl = document.getElementById('next-btn');
    const wrapper = document.getElementById('canvas-wrapper');

    // Circle Progress
    const circumference = 2 * Math.PI * 70;
    progressCircleEl.style.strokeDasharray = `${circumference}`;
    progressCircleEl.style.strokeDashoffset = circumference;

    function preload() {
        faceMesh = ml5.faceMesh(options, () => {
            mainStatusEl.innerHTML = "SYSTEM READY";
        });
    }

    function setup() {
        // 1. Calculate dimensions based on screen width
        // We use a 4:3 aspect ratio which is standard for most phone cameras
        // This prevents the "squeeze"
        let w = Math.min(800, window.innerWidth * 0.9); 
        let h = w * (4/3); // 4:3 Aspect Ratio (Height is 1.33x Width)

        // Set wrapper height explicitly
        wrapper.style.height = h + "px";

        // 2. Create Canvas
        const canvas = createCanvas(w, h);
        canvas.parent('canvas-wrapper');
        
        // 3. Create Video with specific mobile constraints
        video = createCapture({
            audio: false,
            video: {
                facingMode: "user",
                // Prefer ideal resolution for better mesh tracking
                width: { ideal: 640 },
                height: { ideal: 480 }
            }
        });

        video.hide();
        
        // 4. IMPORTANT: Wait for video metadata to load before sizing
        // This fixes the rotation/squeeze on mobile
        video.elt.onloadedmetadata = () => {
            video.size(w, h); // Force internal video element to match canvas
            faceMesh.detectStart(video, results => faces = results);
        };
    }

    function windowResized() {
        // Responsive resize
        let w = Math.min(800, window.innerWidth * 0.9);
        let h = w * (4/3);
        wrapper.style.height = h + "px";
        resizeCanvas(w, h);
        video.size(w, h);
    }

    function draw() {
        background(0); // Clear background
        
        // Draw video
        if(video.loadedmetadata) {
             image(video, 0, 0, width, height);
        }

        if (faces.length > 0) {
            if (!isScanning) startScanning();

            let face = faces[0];
            
            // Draw Dots
            fill(0); 
            noStroke();

            for (let j = 0; j < face.keypoints.length; j++) {
                if (revealedKeypoints[j]) {
                    let k = face.keypoints[j];
                    // On mobile, sometimes x/y need slight adjustment if ratios drift, 
                    // but the resize logic above usually fixes it.
                    circle(k.x, k.y, 4); 
                }
            }
        }
    }

    function startScanning() {
        isScanning = true;
        mainStatusEl.innerHTML = "AUTHENTICATING...";

        let interval = setInterval(() => {
            let index = revealedKeypoints.indexOf(false);

            if (index === -1) {
                clearInterval(interval);
                finishScanning();
                return;
            }

            revealedKeypoints[index] = true;
            revealedCount++;
            updateProgress();

        }, 5); // Speed of scan
    }

    function updateProgress() {
        let p = Math.floor((revealedCount / totalKeypoints) * 100);
        progressValueEl.innerHTML = p + "%";
        const offset = circumference - (p / 100) * circumference;
        progressCircleEl.style.strokeDashoffset = offset;
    }

    function finishScanning() {
        mainStatusEl.innerHTML = "FACE CARD ACCEPTED";
        mainStatusEl.style.color = "#00FF00"; 
        mainStatusEl.style.textShadow = "none"; 

        progressValueEl.innerHTML = "100%";
        progressCircleEl.style.strokeDashoffset = 0;
        nextBtnEl.style.display = "inline-block";
    }
</script>

</body>
</html>