<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Face Card Checking - Identification</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
<script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

<style>
    body {
        margin: 0;
        padding: 0;
        background: black;
        font-family:"Space Grotesk", "Space Mono";
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        gap: 15px;
        text-align: center;
    }

    #small-title {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 3px;
        color: #888;
        margin-top: 25px;
        font-family:"Space Mono";
    }

    #main-status {
        font-size: 1.7rem;
        letter-spacing: 4px;
        font-weight: 700;
        margin-bottom: -5px;
        text-shadow: 0 0 10px rgba(255,255,255,0.4); 
        transition: color 0.3s ease, text-shadow 0.3s ease;
    }

    /* CAMERA FRAME - Desktop Default */
    #canvas-container {
        width: 90%;
        max-width: 800px;
        height: 550px; /* Fixed height for desktop */
        border: 4px solid white;
        position: relative;
        margin-top: 10px;
        overflow: hidden;
    }

    /* P5 Canvas */
    canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
        transform: scaleX(-1); /* Mirror effect */
    }

    #progress-meter {
        width: 110px;
        height: 110px;
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 20;
    }

    #progress-svg {
        transform: rotate(-90deg);
    }

    .circle-bg {
        fill: none;
        stroke: rgba(255, 255, 255, 0.3);
        stroke-width: 5;
    }

    #progress-circle {
        fill: none;
        stroke: white;
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.1s linear;
    }

    #progress-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.3rem;
        font-weight: bold;
        color: white;
    }

    #next-btn {
        margin-top: 15px;
        padding: 12px 40px;
        background: white;
        color: black;
        border-radius: 50px;
        font-weight: 700;
        text-decoration: none;
        display: none;
        text-transform: uppercase;
    }

    /* MOBILE ADJUSTMENTS */
    @media (max-width: 600px) {
        #progress-meter { width: 85px; height: 85px; }
        
        #canvas-container { 
            /* On phone, we remove fixed height and use aspect ratio */
            height: auto; 
            aspect-ratio: 3/4; /* Standard Portrait Ratio */
            max-height: 60vh;
        }
        
        #main-status { font-size: 1.3rem; }
    }
</style>
</head>
<body>

<div id="small-title">✵ FACE CARD CHECKING ✵</div>
<div id="main-status">SYSTEM READY</div>

<div id="canvas-container">
    <div id="progress-meter">
        <svg id="progress-svg" width="100%" height="100%" viewBox="0 0 150 150">
            <circle class="circle-bg" cx="75" cy="75" r="70"/>
            <circle id="progress-circle" cx="75" cy="75" r="70"/>
        </svg>
        <div id="progress-value">0%</div>
    </div>
</div>

<a href="eye_scanning.html" id="next-btn">Continue</a>

<script>
    let faceMesh;
    let video;
    let faces = [];
    const options = { maxFaces: 1 };

    const totalKeypoints = 468;
    let revealedKeypoints = new Array(totalKeypoints).fill(false);
    let revealedCount = 0;
    let isScanning = false;

    // DOM Elements
    const mainStatusEl = document.getElementById('main-status');
    const progressValueEl = document.getElementById('progress-value');
    const progressCircleEl = document.getElementById('progress-circle');
    const nextBtnEl = document.getElementById('next-btn');
    const container = document.getElementById('canvas-container');

    // Circle Progress
    const circumference = 2 * Math.PI * 70;
    progressCircleEl.style.strokeDasharray = `${circumference}`;
    progressCircleEl.style.strokeDashoffset = circumference;

    function preload() {
        faceMesh = ml5.faceMesh(options, () => {
            mainStatusEl.innerHTML = "SYSTEM READY";
        });
    }

    function setup() {
        // 1. Get exact container dimensions
        let w = container.offsetWidth;
        let h = container.offsetHeight;

        // 2. Create Canvas
        const canvas = createCanvas(w, h);
        canvas.parent('canvas-container');

        // 3. Create Video with mobile constraints
        video = createCapture({
            audio: false,
            video: {
                facingMode: "user"
            }
        });
        
        video.hide();

        // 4. IMPORTANT FIX: Force the video element to match the canvas size EXACTLY.
        // This overrides the camera's internal resolution and forces points to align.
        video.size(w, h);

        // 5. Start detecting
        faceMesh.detectStart(video, results => faces = results);
    }

    // Handle Resize (e.g. rotating phone)
    function windowResized() {
        let w = container.offsetWidth;
        let h = container.offsetHeight;
        resizeCanvas(w, h);
        video.size(w, h); // Resize video again to keep sync
    }

    function draw() {
        // Draw video
        image(video, 0, 0, width, height);

        if (faces.length > 0) {
            if (!isScanning) startScanning();

            let face = faces[0];
            
            // Draw Dots
            fill(0); 
            noStroke();

            for (let j = 0; j < face.keypoints.length; j++) {
                if (revealedKeypoints[j]) {
                    let k = face.keypoints[j];
                    // The video is sized to width/height, so k.x and k.y match exactly
                    circle(k.x, k.y, 4); 
                }
            }
        }
    }

    function startScanning() {
        isScanning = true;
        mainStatusEl.innerHTML = "AUTHENTICATING...";

        let interval = setInterval(() => {
            let index = revealedKeypoints.indexOf(false);

            if (index === -1) {
                clearInterval(interval);
                finishScanning();
                return;
            }

            revealedKeypoints[index] = true;
            revealedCount++;
            updateProgress();

        }, 5); // Scan speed
    }

    function updateProgress() {
        let p = Math.floor((revealedCount / totalKeypoints) * 100);
        progressValueEl.innerHTML = p + "%";
        const offset = circumference - (p / 100) * circumference;
        progressCircleEl.style.strokeDashoffset = offset;
    }

    function finishScanning() {
        mainStatusEl.innerHTML = "FACE CARD ACCEPTED";
        mainStatusEl.style.color = "#00FF00"; 
        mainStatusEl.style.textShadow = "none"; 

        progressValueEl.innerHTML = "100%";
        progressCircleEl.style.strokeDashoffset = 0;
        nextBtnEl.style.display = "inline-block";
    }
</script>

</body>
</html>